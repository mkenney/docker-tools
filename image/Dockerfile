FROM golang:1.7-alpine

# docker-tools service
#
# This is a short-lived service that generates documentation and shell scripts
# for the docker-tools application manager. The container should itself be
# managed using a script generated by the container.
LABEL \
    com.webbedlam.contact="Michael Kenney <mkenney@webbedlam.com>" \
    org.label-schema.contact="Michael Kenney <mkenney@webbedlam.com>" \
    org.label-schema.description="Docker container management script and documentation generation service" \
    org.label-schema.docker.cmd.help="docker run --rm -it -e TERM=$TERM $CONTAINER --help" \
    org.label-schema.docker.cmd.install="docker run --rm -it -e $CONTAINER generate docker-tools > /usr/local/bin/docker-tools" \
    org.label-schema.name="docker-tools" \
    org.label-schema.schema-version="1.0" \
    org.label-schema.url="https://github.com/mkenney/docker-tools/" \
    org.label-schema.usage="https://github.com/mkenney/docker-tools/wiki" \
    org.label-schema.vcs-url="https://github.com/mkenney/docker-tools/" \
    org.label-schema.version="0.0.1" \
    org.label-schema.vendor="WebBedlam.com"

ARG GIT_COMMIT

ENV GIT_COMMIT ${GIT_COMMIT}
ENV DOCKER_TOOLS_CONF_DIR /usr/local/docker-tools
ENV TERM xterm-256color

# Setup the image in it's own slice so compiling is fast
RUN set -x \
    && apk update \
    && apk add bash \

    # the base less package needs to be upgraded for xterm and utf8 support
    && apk add less \

    # 3rd-party dependencies
    && apk add git \

        # glog
        && go get github.com/golang/glog \
        # go-yaml
        && go get gopkg.in/yaml.v2 \

    && apk del git \
    && rm -rf /var/cache/apk/*

# Install and build the docker-tools source code
COPY ./ /go/src/docker-tools
RUN set -x \

    # Add the tool sources to gopath, build the binary and link it into the PATH
    && export GOPATH=$GOPATH:/go/src/docker-tools \
    && cd /go/src/docker-tools \
    && go build \
    && ln -s /go/src/docker-tools/docker-tools /go/bin/docker-tools

ENTRYPOINT ["/go/bin/docker-tools"]

